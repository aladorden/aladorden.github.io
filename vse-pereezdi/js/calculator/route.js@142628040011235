var myMap;
ymaps.ready(init);
function init () {
	myMap = new ymaps.Map('map', {
		center:[55.75, 37.62], 
		zoom:9
    });
	var PolygonMKAD = new ymaps.Polygon([ 
	[
	[ 55.774543 ,37.842663],
	[ 55.774543 ,37.842663],
	[ 55.765129 ,37.84269 ], 
	[ 55.75589  ,37.84216 ], 
	[ 55.747672 ,37.842232], 
	[ 55.739098 ,37.841109], 
	[ 55.730517 ,37.840112], 
	[ 55.721782 ,37.839555], 
	[ 55.712173 ,37.836968], 
	[ 55.702566 ,37.832449], 
	[ 55.694271 ,37.829557], 
	[ 55.685214 ,37.831425], 
	[ 55.676732 ,37.834695], 
	[ 55.66763  ,37.837543], 
	[ 55.658535 ,37.839295], 
	[ 55.650881 ,37.834713], 
	[ 55.643749 ,37.824948], 
	[ 55.636433 ,37.813746], 
	[ 55.629521 ,37.803083], 
	[ 55.623666 ,37.793022], 
	[ 55.617657 ,37.781614], 
	[ 55.61114  ,37.769945], 
	[ 55.604819 ,37.758428], 
	[ 55.599077 ,37.747199], 
	[ 55.594763 ,37.736949], 
	[ 55.588135 ,37.721013], 
	[ 55.58407  ,37.709416], 
	[ 55.578971 ,37.695708], 
	[ 55.574157 ,37.682709], 
	[ 55.57209  ,37.668471], 
	[ 55.572767 ,37.649948], 
	[ 55.573749 ,37.63252 ], 
	[ 55.574579 ,37.619243], 
	[ 55.575648 ,37.600828], 
	[ 55.577785 ,37.586814], 
	[ 55.581383 ,37.571866], 
	[ 55.584782 ,37.55761 ], 
	[ 55.590027 ,37.534541], 
	[ 55.59166  ,37.527732], 
	[ 55.596173 ,37.512227], 
	[ 55.602902 ,37.501959], 
	[ 55.609685 ,37.493874], 
	[ 55.616259 ,37.485682], 
	[ 55.623066 ,37.477812], 
	[ 55.63252  ,37.466709], 
	[ 55.639568 ,37.459074], 
	[ 55.646802 ,37.450135], 
	[ 55.65434  ,37.441691], 
	[ 55.66177  ,37.433292], 
	[ 55.671509 ,37.425513], 
	[ 55.680179 ,37.418497], 
	[ 55.687995 ,37.414338], 
	[ 55.695418 ,37.408076], 
	[ 55.70247  ,37.397934], 
	[ 55.709784 ,37.388978], 
	[ 55.718354 ,37.38322 ], 
	[ 55.725427 ,37.379681], 
	[ 55.734978 ,37.37483 ], 
	[ 55.745291 ,37.370131], 
	[ 55.754978 ,37.369368], 
	[ 55.763022 ,37.369062], 
	[ 55.771408 ,37.369691], 
	[ 55.782309 ,37.370086], 
	[ 55.789537 ,37.372979], 
	[ 55.796031 ,37.37862 ], 
	[ 55.806252 ,37.387047], 
	[ 55.81471  ,37.390523], 
	[ 55.824147 ,37.393371], 
	[ 55.832257 ,37.395176], 
	[ 55.840831 ,37.394476], 
	[ 55.850767 ,37.392949], 
	[ 55.858756 ,37.397368], 
	[ 55.866238 ,37.404564], 
	[ 55.872996 ,37.417446], 
	[ 55.876839 ,37.429672], 
	[ 55.88101  ,37.443129], 
	[ 55.882904 ,37.45955 ], 
	[ 55.88513  ,37.474237], 
	[ 55.889361 ,37.489634], 
	[ 55.894737 ,37.503001], 
	[ 55.901823 ,37.519072], 
	[ 55.905654 ,37.529367], 
	[ 55.907682 ,37.543749], 
	[ 55.909418 ,37.559757], 
	[ 55.910881 ,37.575423], 
	[ 55.90913  ,37.590488], 
	[ 55.904902 ,37.607035], 
	[ 55.901152 ,37.621911], 
	[ 55.898735 ,37.633014], 
	[ 55.896458 ,37.652993], 
	[ 55.895661 ,37.664905], 
	[ 55.895106 ,37.681443], 
	[ 55.894046 ,37.697513], 
	[ 55.889997 ,37.711276], 
	[ 55.883636 ,37.723681], 
	[ 55.877359 ,37.736168], 
	[ 55.872743 ,37.74437 ], 
	[ 55.866137 ,37.75718 ], 
	[ 55.8577   ,37.773646], 
	[ 55.854234 ,37.780284], 
	[ 55.848038 ,37.792322], 
	[ 55.840007 ,37.807961], 
	[ 55.835816 ,37.816127], 
	[ 55.828718 ,37.829665], 
	[ 55.821325 ,37.836914], 
	[ 55.811538 ,37.83942 ], 
	[ 55.802472 ,37.840166], 
	[ 55.793925 ,37.841145]
	]
	]);
    myMap.geoObjects.add(PolygonMKAD);
    var PolygonTTK = new ymaps.Polygon([ 
	[
	[55.793081,37.616171],
	[55.792404,37.628702],
	[55.791679,37.634539],
	[55.793855,37.648014],
	[55.793613,37.651104],
	[55.792453,37.654108],
	[55.781378,37.669300],
	[55.779298,37.674021],
	[55.776927,37.680630],
	[55.770493,37.688526],
	[55.769719,37.689041],
	[55.766961,37.688011],
	[55.763912,37.685436],
	[55.760476,37.684750],
	[55.758492,37.685093],
	[55.755201,37.692818],
	[55.748133,37.699513],
	[55.745955,37.699770],
	[55.742275,37.697710],
	[55.740629,37.697281],
	[55.738111,37.697624],
	[55.734333,37.700800],
	[55.725083,37.712559],
	[55.724453,37.712902],
	[55.723387,37.712130],
	[55.723000,37.711701],
	[55.715684,37.685179],
	[55.713746,37.680287],
	[55.711905,37.673592],
	[55.703278,37.657284],
	[55.705831,37.621879],
	[55.705298,37.619733],
	[55.704425,37.617931],
	[55.702075,37.615270],
	[55.701202,37.612695],
	[55.700863,37.611236],
	[55.701008,37.608747],
	[55.702850,37.602567],
	[55.706824,37.587804],
	[55.715062,37.575745],
	[55.717679,37.569222],
	[55.721361,37.556862],
	[55.722039,37.554974],
	[55.723444,37.551798],
	[55.731436,37.543730],
	[55.733325,37.543301],
	[55.734632,37.542528],
	[55.738119,37.537379],
	[55.740104,37.535576],
	[55.743590,37.533602],
	[55.750949,37.531456],
	[55.752643,37.531714],
	[55.766000,37.537379],
	[55.767267,37.538065],
	[55.768912,37.540297],
	[55.770364,37.542614],
	[55.773260,37.545876],
	[55.774573,37.553086],
	[55.775444,37.554631],
	[55.779749,37.558064],
	[55.780862,37.559523],
	[55.791695,37.574887],
	[55.792130,37.595057],
	[55.792759,37.606730]
	]
    ]);
    myMap.geoObjects.add(PolygonTTK);
    var PolygonSAD = new ymaps.Polygon([ 
	[
	[55.773507, 37.625019],
	[55.773507, 37.625019],
	[55.771862, 37.638752],
	[55.769249, 37.646477],
	[55.768282, 37.650253],
	[55.764023, 37.656433],
	[55.7617, 37.657463],
	[55.756861, 37.657806],
	[55.753182, 37.656433],
	[55.752311, 37.65609],
	[55.741951, 37.654888],
	[55.739723, 37.653171],
	[55.740401, 37.652485],
	[55.730813, 37.637207],
	[55.729263, 37.620556],
	[55.728875, 37.614204],
	[55.727616, 37.614891],
	[55.727519, 37.610256],
	[55.729166, 37.612488],
	[55.738464, 37.586395],
	[55.746889, 37.582619],
	[55.758893, 37.584678],
	[55.764217, 37.588798],
	[55.769443, 37.596866],
	[55.772539, 37.60442],
	[55.77312, 37.610771]
	]
	]);
	myMap.geoObjects.add(PolygonSAD);
	var tot_all_const =  $("#calculator_auto .all_price .price_val").text()*1;
	$('#address').blur(function()
	{
		if ($('.input_whence input').val()!="" && $('.input_where input').val() !="")
		{
			var tot_all =  Math.round( $(".car_menu .active").attr("data-cost")*1)+Math.round($("#calculator_auto .lease_time .price_val").text()*1)+Math.round($("#calculator_auto .porter_time .price_val").text()*1);
			$('.lease_ttk, .ttk_time_desc,.lease_sad, .sad_time_desc,.lease_mkad, .mkad_km_desc').removeClass('active_dopoln').hide(); 
			$('#dopoln').hide();
			var st_ad = $('.input_whence input').val();
			var en_ad = $('.input_where input').val();	
					
			ymaps.route([ st_ad, en_ad ]).then(function (res) 
			{
				var pathsObjects = ymaps.geoQuery(res.getPaths()),
					edges = [];
				pathsObjects.each(function (path) 
				{
					var coordinates = path.geometry.getCoordinates();
					for (var i = 1, l = coordinates.length; i < l; i++) 
					{
						edges.push(
						{
							type: 'LineString',
							coordinates: [coordinates[i], coordinates[i - 1]]
						});
					}
				});
				var routeOb = ymaps.geoQuery(res.getWayPoints()).addToMap(myMap),
					objectsMKAD = routeOb.searchInside(PolygonMKAD),			
					objectsInTTK = routeOb.searchInside(PolygonTTK),
					objectsInSAD = routeOb.searchIntersect(PolygonSAD);
				var ind = 0;
				var ttk = ymaps.geoQuery(objectsInTTK).addToMap(myMap);
				var sad = ymaps.geoQuery(objectsInSAD).addToMap(myMap);
				var mkad = ymaps.geoQuery(objectsMKAD).addToMap(myMap);
				var zamkad = routeOb.remove(objectsMKAD);
				var numttk = ttk.getLength();
				var numsad = sad.getLength();
				var numzamkad = 0;
				var distance_all = 0;
				numzamkad = zamkad.getLength();
				if (numttk > 0)
				{
					ind++;
					$('.time_ttk').html('1');
					$("#calculator_auto .ttk_cost").text( $(".car_menu .active").attr("data-margin_ttk"));
					var sum_ttk = $("#calculator_auto .ttk_cost").text()*$('.time_ttk').text()*1;
					$("#calculator_auto .price_ttk").text(sum_ttk);
					tot_all= tot_all + sum_ttk;
					$('.lease_ttk, .ttk_time_desc').addClass('active_dopoln');
					$("#calculator_auto .all_price .price_val").text(tot_all);
				}
				if (numsad > 0)
				{
					ind++;
					$('.time_sad').html('1');
					$("#calculator_auto .sad_cost").text( $(".car_menu .active").attr("data-margin_sadovoe"));
					var sum_sad = $("#calculator_auto .sad_cost").text()*$('.time_sad').text()*1;
					$("#calculator_auto .price_sad").text(sum_sad);
					tot_all= tot_all + sum_sad;
					$('.lease_sad, .sad_time_desc').addClass('active_dopoln');
					$("#calculator_auto .all_price .price_val").text(tot_all);
				}
				if (ind > 0)
				{
					$('#dopoln, #dopoln p.active_dopoln').show();
				}
				var routeObjects = ymaps.geoQuery(edges)
					.setOptions('strokeWidth', 3)
					.addToMap(myMap),
					objectsInMoscow = routeObjects.searchInside(PolygonMKAD),
					boundaryObjects = routeObjects.searchIntersect(PolygonMKAD);
				var zamk = routeObjects.remove(objectsInMoscow).remove(boundaryObjects);
				var zamkad = ymaps.geoQuery(zamk).addToMap(myMap);
				var num = zamkad.getLength()-1;	
				if (numzamkad ==1 )
				{
					ind++;			
					var new_st = zamkad.get(0).geometry.get(0);
					var num2 = zamkad.get(num).geometry.getLength()-1;
					var new_en = zamkad.get(num).geometry.get(num2);
					ymaps.route([new_st, new_en]).then(function (router) 
					{
						var distance = Math.round(router.getLength() / 1000)*2;
						$('.km_mkad').html(distance);
						$("#calculator_auto .mkad_cost").text( $(".car_menu .active").attr("data-margin_mkad"));
						var sum_mkad = $("#calculator_auto .mkad_cost").text()*$('.km_mkad').text()*1;
						$("#calculator_auto .price_mkad").text(sum_mkad);
						tot_all= tot_all + sum_mkad;
						$('.lease_mkad, .mkad_km_desc').addClass('active_dopoln');
						$('#dopoln, #dopoln p.active_dopoln').show();		      
						$("#calculator_auto .all_price .price_val").text(tot_all);
			  
					});
				}
				if (numzamkad == 2)
				{
					ind++;	
					ymaps.route(['Москва',st_ad,en_ad,'Москва']).then(function (reszamkad)  
					{
						var pathsOb = ymaps.geoQuery(reszamkad.getPaths()),
						edg = [];
						pathsOb.each(function (path)
						{
							var coord = path.geometry.getCoordinates();
							for (var i = 1, l = coord.length; i < l; i++) 
							{
								edg.push(
								{
									type: 'LineString',
									coordinates: [coord[i], coord[i - 1]]
								});	
							}	
						});
						var routeObj = ymaps.geoQuery(edg).addToMap(myMap),
						objectsInMoscow1 = routeObj.searchInside(PolygonMKAD),
						boundaryObjects1 = routeObj.searchIntersect(PolygonMKAD);
						var zamknew = routeObj.remove(objectsInMoscow1).remove(boundaryObjects1);
						var zamkadnew = ymaps.geoQuery(zamknew).addToMap(myMap);
						var num = zamkadnew.getLength()-1;	
						var new_st = zamkadnew.get(0).geometry.get(0);
						var num2 = zamkadnew.get(num).geometry.getLength()-1;
						var new_en = zamkadnew.get(num).geometry.get(num2);
						ymaps.route([new_st,st_ad,en_ad, new_en]).then(function (routermk) 
						{
							var distance = Math.round(routermk.getLength() / 1000);
							$('.km_mkad').html(distance);
							$("#calculator_auto .mkad_cost").text( $(".car_menu .active").attr("data-margin_mkad"));
							var sum_mkad = $("#calculator_auto .mkad_cost").text()*$('.km_mkad').text()*1;
							$("#calculator_auto .price_mkad").text(sum_mkad);
							tot_all= tot_all + sum_mkad;
							$('.lease_mkad, .mkad_km_desc').addClass('active_dopoln');
							$('#dopoln, #dopoln p.active_dopoln').show();		      
							$("#calculator_auto .all_price .price_val").text(tot_all);
				  
						});	
			  
					});
			
				}
			});
		   
		}
 
	});
}; 